<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faculty Command Center</title>

  <link rel="icon" type="image/svg+xml" href="favicon.svg" />

  <!-- Google Fonts for Premium Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
    rel="stylesheet" />

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/stepper_partial.css" />
  <!-- PDF.js for parsing PDFs in browser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Set worker src
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>
  <script>
    // Immediate Auth Check to prevent content flash
    (function () {
      const user = sessionStorage.getItem("faculty_user");
      if (!user) {
        window.location.replace("login.html");
      } else {
        // Optional: Validate token structure if needed
        try {
          const u = JSON.parse(user);
          if (!u.username || !u.role) {
            sessionStorage.removeItem("faculty_user");
            window.location.replace("login.html");
          }
        } catch (e) {
          sessionStorage.removeItem("faculty_user");
          window.location.replace("login.html");
        }
      }
    })();
  </script>
</head>

<body style="opacity: 0; transition: opacity 0.3s ease">
  <script>
    // Show body if we get here (auth passed)
    document.addEventListener("DOMContentLoaded", () => {
      document.body.style.opacity = "1";
    });
  </script>
  <div class="app-container">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="brand">
        <!-- <div class="logo-icon">Q</div> -->
        <h2>Faculty <span class="highlight">Portal</span></h2>
      </div>

      <nav class="nav-menu">
        <button class="nav-btn active" data-tab="create-quiz" onclick="switchTab('create-quiz')">
          <span class="icon"><img src="icons/icons8-question-48.png" alt="Generate" style="width: 24px;"></span>
          Generate
        </button>
        <button class="nav-btn" data-tab="active-sessions" onclick="switchTab('active-sessions')">
          <span class="icon"><img src="icons/icons8-history-48.png" alt="Session History" style="width: 24px;"></span>
          Session History
        </button>
        <button class="nav-btn" data-tab="scoreboard" onclick="switchTab('scoreboard')">
          <span class="icon"><img src="icons/icons8-report-card-48.png" alt="Results" style="width: 24px;"></span>
          Results
        </button>
        <div style="flex:1"></div> <!-- Spacer -->
        <!-- Settings removed as per request -->
      </nav>

      <div class="user-profile">
        <div class="avatar">F</div>
        <div class="info">
          <span class="name">Faculty User</span>
          <span class="role">Admin</span>
        </div>
        <button class="logout-btn" onclick="logout()" title="Logout">
          <span class="icon"><img src="icons/icons8-logout-48.png" alt="Logout" style="width: 24px;"></span>
        </button>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
      <!-- Create Quiz Tab -->
      <section id="create-quiz" class="tab-content active">

        <!-- Top Panel with Stepper and Header -->
        <div
          style="background: white; border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem;">

          <!-- Stepper -->
          <div class="stepper-container"
            style="margin-bottom: 0.5rem; transform: scale(1.1); width: 100%; max-width: 500px;">
            <div class="stepper">
              <div class="step-item active" data-step="1">
                <div class="step-circle">1</div>
                <span class="step-label">Configure</span>
              </div>
              <div class="step-line"></div>
              <div class="step-item" data-step="2">
                <div class="step-circle">2</div>
                <span class="step-label">Generate</span>
              </div>
              <div class="step-line"></div>
              <div class="step-item" data-step="3">
                <div class="step-circle">3</div>
                <span class="step-label">Review</span>
              </div>
            </div>
          </div>

          <!-- Header -->
          <header class="section-header" style="text-align: center; margin-bottom: 0;">
            <h1 style="font-size: 1.5rem; font-weight: 700; margin: 0; color: #1f2937;">Create New Quiz</h1>
            <p style="color: #6b7280; font-size: 0.9rem; margin: 5px 0 0 0;">AI-powered Question Generation & Review
            </p>
          </header>
        </div>


        <div class="grid-layout">
          <!-- Left Column: Configuration -->
          <div class="col-left">
            <!-- Configuration Card -->
            <div class="card">
              <div class="card-header">
                <h3 style="margin: 0;">Configuration</h3>
              </div>

              <div class="card-body">
                <!-- Quiz Topic -->
                <div style="margin-bottom: 1.25rem;">
                  <label
                    style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Quiz
                    Topic / Title</label>
                  <input type="text" id="quiz-title" placeholder="e.g. Introduction to Machine Learning">
                </div>

                <!-- 3-Column Inputs Row -->
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.25rem;">
                  <div>
                    <label
                      style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Total
                      Questions</label>
                    <input type="number" id="q-count" value="10" min="1" max="50">
                  </div>
                  <div>
                    <label
                      style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Number
                      of Sets</label>
                    <input type="number" id="q-sets" value="1" min="1" max="10">
                  </div>
                  <div>
                    <label
                      style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Duration
                      (Min)</label>
                    <input type="number" id="duration" value="60" min="10" max="180">
                  </div>
                </div>

                <!-- Syllabus Area (Full Width) -->
                <div class="form-group" style="margin-top: 1rem; width: 100%;">
                  <label>Syllabus Content</label>
                  <textarea id="syllabus-text" placeholder="Paste text or drag PDF..."
                    style="height: 120px; border-radius: var(--radius-sm); width: 100%;"></textarea>

                  <!-- Actions Row -->
                  <div style="margin-top: 1rem; display: flex; gap: 0.75rem;">
                    <!-- Upload PDF Button -->
                    <label for="file-upload" class="btn-secondary"
                      style="flex: 1; cursor: pointer; text-align: center; justify-content: center;">
                      <img src="icons/icons8-upload-48.png" alt="Upload" style="width: 20px; opacity: 0.7;"> Upload PDF
                    </label>
                    <input type="file" id="file-upload" hidden accept=".txt,.pdf">
                    <span id="file-details" class="hidden"></span>

                    <!-- Analyze Syllabus Button -->
                    <button id="analyze-btn" onclick="analyzeSyllabus()" class="btn-outline" style="flex: 2;">
                      <span class="btn-icon" style="padding:0;"><img src="icons/icons8-search-32.png" alt="Analyze"
                          style="width: 20px;"></span> Analyze & COs
                    </button>
                  </div>

                  <!-- Chapter Weights Section (Hidden by default) -->
                  <div id="weights-container" class="hidden" style="
                        margin-top: 20px;
                        border-top: 1px solid var(--border-color);
                        padding-top: 15px;
                      ">
                    <h4 style="margin-bottom: 10px; font-size: 0.95rem;">Chapter Weights & CO Analysis</h4>
                    <div id="weights-list" class="form-grid">
                      <!-- Populated by JS -->
                    </div>
                    <div id="weights-summary" style="
                          margin-top: 10px;
                          font-size: 0.85rem;
                          text-align: right;
                        ">
                      Total Weight: <span id="total-weight">0</span>%
                    </div>
                  </div>
                </div>

                <!-- Generate Questions Button (Moved inside body) -->
                <button class="btn-primary full-width" id="generate-btn" onclick="generateQuestions()"
                  style="margin-top: 1.5rem;">
                  <span class="btn-icon" style="color: white; opacity: 1;">
                    <img src="icons/icons8-faq-48.png" alt="Generate"
                      style="width: 20px; filter: brightness(0) invert(1);">
                  </span> Generate Questions
                </button>
              </div>
            </div>
          </div>

          <!-- Right Column: Question Preview -->
          <div class="col-right">
            <!-- Single Unified White Card -->
            <div class="card">

              <!-- Header -->
              <div class="card-header"
                style="justify-content: space-between; border-bottom: 1px solid var(--border-color);">
                <h3 style="font-size: 1.35rem; font-weight: 700; color: #1f2937; margin: 0;">
                  Review Questions
                  <span class="badge" id="q-badge"
                    style="margin-left: 0.5rem; background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem;">0</span>
                </h3>
                <button onclick="clearAllQuestions()" class="btn-text" style="color: var(--danger-color);">
                  Clear All
                </button>
              </div>

              <div class="card-body">
                <!-- Filters -->
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                  <select id="filter-chapter" class="form-select" onchange="applyFilters()" style="flex: 1;">
                    <option value="">All Chapters</option>
                  </select>
                  <select id="filter-co" class="form-select" onchange="applyFilters()" style="flex: 1;">
                    <option value="">All COs</option>
                  </select>
                </div>

                <!-- Questions List (Scrollable) -->
                <div id="questions-list" style="flex: 1; min-height: 0; overflow-y: auto; margin-bottom: 1rem;">
                  <div class="empty-state"
                    style="display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-muted); gap: 1rem; padding: 2rem 0;">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"
                      style="opacity: 0.4;">
                      <path
                        d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                    </svg>
                    <p style="margin: 0; font-size: 0.9rem;">No questions generated yet.</p>
                  </div>
                </div>

                <!-- Action Buttons Row (Stuck to bottom) -->
                <div
                  style="display: flex; gap: 0.75rem; margin-top: auto; padding-top: 1.25rem; border-top: 1px solid var(--border-color); flex: none;">
                  <button id="start-session-btn" onclick="startSession()" disabled class="btn-success"
                    style="flex: 2; height: 44px;">
                    Start Session
                  </button>
                  <button onclick="openScheduleModal()" id="schedule-btn" class="btn-secondary" disabled
                    style="flex: 1; height: 44px;">
                    <span class="icon" style="margin-right: 5px;">
                      <img src="icons/icons8-schedule-48.png" alt="Schedule" style="width: 20px;">
                    </span> Schedule
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
  </div>
  </section>

  <!-- Active Sessions Tab -->
  <section id="active-sessions" class="tab-content">
    <header class="section-header">
      <h1>Active Sessions</h1>
      <p>Manage currently running quizzes.</p>
    </header>

    <!-- Latest Session Info -->
    <div class="card glass-panel highlight-card hidden" id="current-session-card">
      <div class="session-hero">
        <div class="status-indicator live">LIVE</div>
        <div class="details">
          <h2>Session Active</h2>
          <div class="codes">
            <div class="code-block">
              <span class="label">Session ID</span>
              <span class="value" id="disp-sess-id">--</span>
            </div>
            <div class="code-block">
              <span class="label">OTP</span>
              <span class="value" id="disp-otp">--</span>
            </div>
          </div>
        </div>
        <div class="controls">
          <button class="btn-secondary" onclick="copySessionInfo()">
            Copy Info
          </button>
          <button class="btn-danger" onclick="stopCurrentSession()">
            Stop Session
          </button>
        </div>
      </div>
    </div>

    <div class="card glass-panel">
      <div class="card-header">
        <h3>Session History</h3>
        <button class="btn-icon" onclick="loadSessions()"><img src="icons/reload.png" alt="Refresh" /></button>
      </div>
      <div class="card-body">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Title</th>
              <th>Status</th>
              <th>OTP</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="sessions-table-body">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Scoreboard Tab -->
  <section id="scoreboard" class="tab-content">
    <header class="section-header">
      <h1>Live Scoreboard</h1>
      <div class="header-controls">
        <input type="text" placeholder="Enter Session ID" id="scoreboard-sess-id" class="search-input" />
        <button class="btn-primary" onclick="loadScoreboard()">
          Load
        </button>
      </div>
    </header>

    <!-- Session Analytics Dashboard -->
    <div id="session-analytics" class="card glass-panel hidden" style="margin-bottom: 20px;">
      <div class="card-header">
        <h3>Session Overview</h3>
      </div>
      <div class="card-body" style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div
          style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; text-align: center;">
          <h4 style="margin:0; color: var(--text-muted); font-size: 0.9rem;">Average Score</h4>
          <div id="analytics-avg" style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">--</div>
        </div>
        <div
          style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; text-align: center;">
          <h4 style="margin:0; color: var(--text-muted); font-size: 0.9rem;">Highest Score</h4>
          <div id="analytics-high" style="font-size: 2rem; font-weight: 700; color: var(--success-color);">--</div>
        </div>
        <div
          style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; text-align: center;">
          <h4 style="margin:0; color: var(--text-muted); font-size: 0.9rem;">Lowest Score</h4>
          <div id="analytics-low" style="font-size: 2rem; font-weight: 700; color: var(--danger-color);">--</div>
        </div>
      </div>
      <div class="card-body">
        <h4 style="margin-bottom: 15px;">Course Outcome (CO) Performance</h4>
        <div id="analytics-co-chart" style="display: flex; gap: 10px; flex-direction: column;">
          <!-- CO Bars injected here -->
        </div>
      </div>
    </div>

    <div class="card glass-panel">
      <div class="card-body">
        <table class="data-table scoreboard-table">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Student Name</th>
              <th>Enrollment</th>
              <th>Score</th>
              <th>Time</th>
              <th>Status</th>
              <th>Details</th>
            </tr>
            </tr>
          </thead>
          <tbody id="scoreboard-body">
            <tr>
              <td colspan="6" class="text-center">
                Enter a Session ID to view results.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>
  </main>
  </div>

  <!-- Modal for Question Editing -->
  <div class="modal" id="edit-modal">
    <div class="modal-content glass-panel">
      <div class="modal-header">
        <h3>Edit Question</h3>
        <button class="close-btn" onclick="closeModal()">×</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-index" />
        <div class="form-group">
          <label>Question Text</label>
          <textarea id="edit-text" rows="3"></textarea>
        </div>
        <div class="options-grid">
          <div class="form-group">
            <label>Option A</label>
            <input type="text" id="edit-opt-a" />
          </div>
          <div class="form-group">
            <label>Option B</label>
            <input type="text" id="edit-opt-b" />
          </div>
          <div class="form-group">
            <label>Option C</label>
            <input type="text" id="edit-opt-c" />
          </div>
          <div class="form-group">
            <label>Option D</label>
            <input type="text" id="edit-opt-d" />
          </div>
        </div>
        <div class="form-group">
          <label>Correct Answer</label>
          <select id="edit-correct">
            <option value="A">Option A</option>
            <option value="B">Option B</option>
            <option value="C">Option C</option>
            <option value="D">Option D</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" onclick="saveQuestionEdit()">
          Save Changes
        </button>
      </div>
    </div>
  </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal" id="schedule-modal">
    <div class="modal-content glass-panel" style="max-width: 400px;">
      <div class="modal-header">
        <h3>Schedule Quiz Start</h3>
        <button class="close-btn" onclick="closeScheduleModal()">×</button>
      </div>
      <div class="modal-body">
        <p style="color: var(--text-muted); margin-bottom: 1rem;">Set a time for the quiz to start automatically.</p>
        <div class="form-group">
          <label>Start Time</label>
          <input type="datetime-local" id="schedule-datetime">
        </div>
        <div class="form-group" style="margin-top: 1rem;">
          <div id="schedule-countdown"
            style="text-align: center; font-size: 1.2rem; font-weight: 700; color: var(--accent-color); display: none;">
            Starts in: <span id="countdown-timer">00:00:00</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeScheduleModal()">Cancel</button>
        <button class="btn-primary" onclick="confirmSchedule()">
          Set Schedule
        </button>
      </div>
    </div>
  </div>

  <!-- Student Details Modal -->
  <div class="modal" id="student-details-modal">
    <div class="modal-content glass-panel" style="max-width: 800px; width: 95%;">
      <div class="modal-header">
        <h3>Student Insight</h3>
        <button class="close-btn" onclick="closeStudentModal()">×</button>
      </div>
      <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
        <div
          style="display: flex; justify-content: space-between; margin-bottom: 20px; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px;">
          <div>
            <strong>Score:</strong> <span id="detail-score" style="font-size: 1.2rem;">--</span>
          </div>
          <div>
            <strong>Cheat Status:</strong> <span id="detail-cheated">--</span>
          </div>
        </div>

        <h4>CO Proficiency</h4>
        <div id="detail-co-stats" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <!-- CO badges -->
        </div>

        <h4>Question Breakdown</h4>
        <div id="detail-answers-list" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Q&A list -->
        </div>
      </div>
    </div>
  </div>

  <script src="js/config.js?v=3"></script>
  <script src="js/app.js?v=3"></script>
  <script>
    // HTML Hack: Define missing function that app.js calls
    function refreshStepperState() {
      const syllabusText = document.getElementById('syllabus-text');
      const hasContent = syllabusText && syllabusText.value.trim().length > 0;
      if (typeof questions !== 'undefined' && questions.length > 0) {
        updateStepper(3);
      } else if (hasContent) {
        updateStepper(2);
      } else {
        updateStepper(1);
      }
    }

    // HTML Hack: Suppress "Generated X questions successfully" popup
    const originalAlert = window.alert;
    window.alert = function (msg) {
      if (msg && msg.includes('questions successfully')) {
        console.log(msg); // Log to console instead
        return;
      }
      originalAlert(msg);
    };
  </script>
</body>

</html>