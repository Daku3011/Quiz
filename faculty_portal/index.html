<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faculty Command Center</title>

  <link rel="icon" type="image/svg+xml" href="favicon.svg" />

  <!-- Google Fonts for Premium Typography -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap"
    rel="stylesheet" />

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/stepper_partial.css" />
  <!-- PDF.js for parsing PDFs in browser -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // Set worker src
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>
  <script>
    // Immediate Auth Check to prevent content flash
    (function () {
      const user = sessionStorage.getItem("faculty_user");
      if (!user) {
        window.location.replace("login.html");
      } else {
        // Optional: Validate token structure if needed
        try {
          const u = JSON.parse(user);
          if (!u.username || !u.role) {
            sessionStorage.removeItem("faculty_user");
            window.location.replace("login.html");
          }
        } catch (e) {
          sessionStorage.removeItem("faculty_user");
          window.location.replace("login.html");
        }
      }
    })();
  </script>
</head>

<body style="opacity: 0; transition: opacity 0.3s ease">
  <script>
    // Show body if we get here (auth passed)
    document.addEventListener("DOMContentLoaded", () => {
      document.body.style.opacity = "1";
    });
  </script>
  <div class="app-container">
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
      <div class="brand">
        <!-- <div class="logo-icon">Q</div> -->
        <h2>Faculty <span class="highlight">Portal</span></h2>
      </div>

      <nav class="nav-menu">
        <button class="nav-btn active" data-tab="create-quiz" onclick="switchTab('create-quiz')">
          <span class="icon">âœ¨</span> Generate
        </button>
        <button class="nav-btn" data-tab="active-sessions" onclick="switchTab('active-sessions')">
          <span class="icon">ðŸ“š</span> Session History
        </button>
        <button class="nav-btn" data-tab="scoreboard" onclick="switchTab('scoreboard')">
          <span class="icon">ðŸ“Š</span> Results
        </button>
        <div style="flex:1"></div> <!-- Spacer -->
        <!-- Settings removed as per request -->
      </nav>

      <div class="user-profile">
        <div class="avatar">F</div>
        <div class="info">
          <span class="name">Faculty User</span>
          <span class="role">Admin</span>
        </div>
        <button class="logout-btn" onclick="logout()" title="Logout">
          <span class="icon">ðŸšª</span>
        </button>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
      <!-- Create Quiz Tab -->
      <section id="create-quiz" class="tab-content active">

        <!-- Top Panel with Stepper and Header -->
        <div
          style="background: white; border-radius: 16px; padding: 2rem 3rem; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">

          <!-- Stepper -->
          <div class="stepper-container" style="margin-bottom: 1.5rem;">
            <div class="stepper">
              <div class="step-item active" data-step="1">
                <div class="step-circle">1</div>
                <span class="step-label">Configure</span>
              </div>
              <div class="step-line"></div>
              <div class="step-item" data-step="2">
                <div class="step-circle">2</div>
                <span class="step-label">Generate</span>
              </div>
              <div class="step-line"></div>
              <div class="step-item" data-step="3">
                <div class="step-circle">3</div>
                <span class="step-label">Review</span>
              </div>
            </div>
          </div>

          <!-- Header -->
          <header class="section-header" style="text-align: center;">
            <h1 style="font-size: 1.5rem; font-weight: 700; margin: 0 0 0.5rem 0; color: #1f2937;">Create New Quiz</h1>
            <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">Generate questions from syllabus content using AI.
            </p>
          </header>
        </div>


        <div class="grid-layout">
          <!-- Left Column: Configuration -->
          <div class="col-left">
            <!-- Configuration Card -->
            <div
              style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">

              <h3 style="font-size: 1.15rem; font-weight: 600; color: #1f2937; margin: 0 0 1.5rem 0;">Configuration</h3>

              <!-- Quiz Topic -->
              <div style="margin-bottom: 1.25rem;">
                <label
                  style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Quiz
                  Topic / Title</label>
                <input type="text" id="quiz-title" placeholder="e.g. Introduction to Machine Learning"
                  style="width: 100%; padding: 0.75rem 1rem; border: 1.5px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; color: #374151; background: white; outline: none; transition: border-color 0.2s;"
                  onfocus="this.style.borderColor='#7c3aed'" onblur="this.style.borderColor='#e5e7eb'">
              </div>

              <!-- Two Columns: Questions & Sets -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.25rem;">
                <div>
                  <label
                    style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Total
                    Questions</label>
                  <input type="number" id="q-count" value="10" min="1" max="50"
                    style="width: 100%; padding: 0.75rem 1rem; border: 1.5px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; color: #374151; background: white; outline: none;"
                    onfocus="this.style.borderColor='#7c3aed'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
                <div>
                  <label
                    style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Number
                    of Sets</label>
                  <input type="number" id="q-sets" value="1" min="1" max="10"
                    style="width: 100%; padding: 0.75rem 1rem; border: 1.5px solid #e5e7eb; border-radius: 10px; font-size: 0.95rem; color: #374151; background: white; outline: none;"
                    onfocus="this.style.borderColor='#7c3aed'" onblur="this.style.borderColor='#e5e7eb'">
                </div>
              </div>

              <!-- Syllabus Content -->
              <div style="margin-bottom: 1rem;">
                <label
                  style="display: block; font-size: 0.85rem; color: #6b7280; margin-bottom: 0.5rem; font-weight: 500;">Syllabus
                  Content</label>
                <textarea id="syllabus-text" placeholder="Paste text or drop PDF..."
                  style="width: 100%; height: 120px; padding: 0.75rem 1rem; border: 1.5px solid #e5e7eb; border-radius: 10px; font-size: 0.9rem; color: #374151; background: white; resize: none; outline: none; font-family: inherit;"
                  onfocus="this.style.borderColor='#7c3aed'" onblur="this.style.borderColor='#e5e7eb'"></textarea>
              </div>

              <!-- Upload PDF Button - Orange with hover -->
              <div style="margin-bottom: 1.25rem;">
                <label for="file-upload" class="upload-btn"
                  style="display: inline-flex; align-items: center; gap: 8px; padding: 0.6rem 1.25rem; font-size: 0.85rem; cursor: pointer; background: transparent; border: 1.5px solid #f59e0b; color: #f59e0b; border-radius: 8px; font-weight: 500; transition: all 0.2s;"
                  onmouseover="this.style.background='#f59e0b'; this.style.color='white';"
                  onmouseout="this.style.background='transparent'; this.style.color='#f59e0b';">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                  </svg>
                  Upload PDF
                </label>
                <input type="file" id="file-upload" hidden accept=".txt,.pdf">
                <span id="file-details" style="font-size: 0.8rem; color: #9ca3af; margin-left: 12px;"></span>
              </div>

              <!-- Analyze Button - Purple Outlined with glassmorphism hover -->
              <button id="analyze-btn" onclick="analyzeSyllabus()"
                style="width: 100%; padding: 0.85rem; background: transparent; border: 1.5px solid #7c3aed; color: #7c3aed; border-radius: 10px; font-size: 0.9rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 1rem; transition: all 0.2s;"
                onmouseover="this.style.background='rgba(124, 58, 237, 0.08)'; this.style.boxShadow='0 4px 15px rgba(124, 58, 237, 0.15)';"
                onmouseout="this.style.background='transparent'; this.style.boxShadow='none';">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="11" cy="11" r="8"></circle>
                  <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                </svg>
                Analyze Syllabus & COs
              </button>

              <!-- Chapter Weights Section (Hidden by default) -->
              <div id="weights-container" class="hidden"
                style="margin-bottom: 1rem; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                <h4 style="margin-bottom: 10px; font-size: 0.95rem; color: #374151;">Chapter Weights & CO Analysis</h4>
                <div id="weights-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                  <!-- Populated by JS -->
                </div>
                <div id="weights-summary"
                  style="margin-top: 10px; font-size: 0.85rem; text-align: right; color: #6b7280;">
                  Total Weight: <span id="total-weight">0</span>%
                </div>
              </div>

              <!-- Generate Button - Purple Gradient with hover -->
              <button id="generate-btn" onclick="generateQuestions()"
                style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%); border: none; color: white; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(124, 58, 237, 0.35); transition: all 0.2s;"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(124, 58, 237, 0.45)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(124, 58, 237, 0.35)';">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <path
                    d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                </svg>
                Generate Questions
              </button>
            </div>
          </div>

          <!-- Right Column: Question Preview -->
          <div class="col-right"
            style="overflow: visible; padding: 5px; display: flex; flex-direction: column; gap: 1rem;">
            <!-- White Card Box -->
            <div
              style="background: white; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); flex: 1; display: flex; flex-direction: column; padding: 1.5rem; overflow: hidden;">

              <!-- Header -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.25rem;">
                <h3 style="font-size: 1.35rem; font-weight: 700; font-style: normal; color: #1f2937; margin: 0;">
                  Review Questions
                  <span class="badge" id="q-badge"
                    style="margin-left: 0.5rem; background: #7c3aed; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.85rem;">0</span>
                </h3>
                <button onclick="addManually()"
                  style="background: transparent; border: none; color: #14b8a6; font-size: 0.9rem; font-weight: 500; cursor: pointer;">
                  + Add Manual
                </button>
              </div>

              <!-- Filters - Stacked Vertically -->
              <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
                <select id="filter-chapter" class="form-select" onchange="applyFilters()"
                  style="width: 100%; padding: 0.75rem 1rem; border: 1.5px solid #e5e7eb; border-radius: 10px; font-size: 0.9rem; color: #374151; background: white; cursor: pointer;">
                  <option value="">All Chapters</option>
                </select>
                <select id="filter-co" class="form-select" onchange="applyFilters()"
                  style="width: 100%; padding: 0.75rem 1rem; border: 1.5px solid #e5e7eb; border-radius: 10px; font-size: 0.9rem; color: #374151; background: white; cursor: pointer;">
                  <option value="">All COs</option>
                </select>
              </div>

              <!-- Questions List -->
              <div class="card-body scrollable-list" id="questions-list" style="flex: 1; overflow-y: auto;">
                <div class="empty-state"
                  style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #9ca3af;">
                  <!-- Star Icon -->
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="1.5"
                    style="margin-bottom: 1rem;">
                    <path
                      d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
                  </svg>
                  <p style="margin: 0; font-size: 0.9rem;">No questions generated yet.</p>
                </div>
              </div>
            </div>

            <!-- Buttons OUTSIDE the box -->
            <div style="display: flex; flex-direction: column; gap: 0.75rem; flex-shrink: 0;">
              <!-- Clear All Button - Outlined -->
              <button onclick="clearAllQuestions()"
                style="width: 100%; padding: 0.85rem; background: white; border: 1.5px solid #e5e7eb; color: #6b7280; border-radius: 10px; font-size: 0.9rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.06);"
                onmouseover="this.style.background='#fee2e2'; this.style.borderColor='#fca5a5'; this.style.color='#dc2626';"
                onmouseout="this.style.background='white'; this.style.borderColor='#e5e7eb'; this.style.color='#6b7280';">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="3 6 5 6 21 6"></polyline>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                Clear All
              </button>

              <!-- Start Session Button - Green Gradient with hover -->
              <button id="start-session-btn" onclick="startSession()" disabled
                style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #10b981 0%, #14b8a6 100%); border: none; color: white; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.35); transition: all 0.3s ease; opacity: 0.6;"
                onmouseover="this.style.transform='translateY(-3px) scale(1.02)'; this.style.boxShadow='0 8px 25px rgba(16, 185, 129, 0.5)'; this.style.opacity='0.85';"
                onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 15px rgba(16, 185, 129, 0.35)'; this.style.opacity='0.6';">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                  <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                Start Session
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Active Sessions Tab -->
      <section id="active-sessions" class="tab-content">
        <header class="section-header">
          <h1>Active Sessions</h1>
          <p>Manage currently running quizzes.</p>
        </header>

        <!-- Latest Session Info -->
        <div class="card glass-panel highlight-card hidden" id="current-session-card">
          <div class="session-hero">
            <div class="status-indicator live">LIVE</div>
            <div class="details">
              <h2>Session Active</h2>
              <div class="codes">
                <div class="code-block">
                  <span class="label">Session ID</span>
                  <span class="value" id="disp-sess-id">--</span>
                </div>
                <div class="code-block">
                  <span class="label">OTP</span>
                  <span class="value" id="disp-otp">--</span>
                </div>
              </div>
            </div>
            <div class="controls">
              <button class="btn-secondary" onclick="copySessionInfo()">
                Copy Info
              </button>
              <button class="btn-danger" onclick="stopCurrentSession()">
                Stop Session
              </button>
            </div>
          </div>
        </div>

        <div class="card glass-panel">
          <div class="card-header">
            <h3>Session History</h3>
            <button class="btn-icon" onclick="loadSessions()"><img src="icons/reload.png" alt="Refresh" /></button>
          </div>
          <div class="card-body">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Title</th>
                  <th>Status</th>
                  <th>OTP</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="sessions-table-body">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Scoreboard Tab -->
      <section id="scoreboard" class="tab-content">
        <header class="section-header">
          <h1>Live Scoreboard</h1>
          <div class="header-controls">
            <input type="text" placeholder="Enter Session ID" id="scoreboard-sess-id" class="search-input" />
            <button class="btn-primary" onclick="loadScoreboard()">
              Load
            </button>
          </div>
        </header>

        <!-- Session Analytics Dashboard -->
        <div id="session-analytics" class="card glass-panel hidden" style="margin-bottom: 20px;">
          <div class="card-header">
            <h3>Session Overview</h3>
          </div>
          <div class="card-body" style="display: flex; gap: 20px; flex-wrap: wrap;">
            <div
              style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; text-align: center;">
              <h4 style="margin:0; color: var(--text-muted); font-size: 0.9rem;">Average Score</h4>
              <div id="analytics-avg" style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">--</div>
            </div>
            <div
              style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; text-align: center;">
              <h4 style="margin:0; color: var(--text-muted); font-size: 0.9rem;">Highest Score</h4>
              <div id="analytics-high" style="font-size: 2rem; font-weight: 700; color: var(--success-color);">--</div>
            </div>
            <div
              style="flex: 1; min-width: 200px; background: rgba(255,255,255,0.5); padding: 15px; border-radius: 12px; text-align: center;">
              <h4 style="margin:0; color: var(--text-muted); font-size: 0.9rem;">Lowest Score</h4>
              <div id="analytics-low" style="font-size: 2rem; font-weight: 700; color: var(--danger-color);">--</div>
            </div>
          </div>
          <div class="card-body">
            <h4 style="margin-bottom: 15px;">Course Outcome (CO) Performance</h4>
            <div id="analytics-co-chart" style="display: flex; gap: 10px; flex-direction: column;">
              <!-- CO Bars injected here -->
            </div>
          </div>
        </div>

        <div class="card glass-panel">
          <div class="card-body">
            <table class="data-table scoreboard-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Student Name</th>
                  <th>Enrollment</th>
                  <th>Score</th>
                  <th>Time</th>
                  <th>Status</th>
                  <th>Details</th>
                </tr>
                </tr>
              </thead>
              <tbody id="scoreboard-body">
                <tr>
                  <td colspan="6" class="text-center">
                    Enter a Session ID to view results.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal for Question Editing -->
  <div class="modal" id="edit-modal">
    <div class="modal-content glass-panel">
      <div class="modal-header">
        <h3>Edit Question</h3>
        <button class="close-btn" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-index" />
        <div class="form-group">
          <label>Question Text</label>
          <textarea id="edit-text" rows="3"></textarea>
        </div>
        <div class="options-grid">
          <div class="form-group">
            <label>Option A</label>
            <input type="text" id="edit-opt-a" />
          </div>
          <div class="form-group">
            <label>Option B</label>
            <input type="text" id="edit-opt-b" />
          </div>
          <div class="form-group">
            <label>Option C</label>
            <input type="text" id="edit-opt-c" />
          </div>
          <div class="form-group">
            <label>Option D</label>
            <input type="text" id="edit-opt-d" />
          </div>
        </div>
        <div class="form-group">
          <label>Correct Answer</label>
          <select id="edit-correct">
            <option value="A">Option A</option>
            <option value="B">Option B</option>
            <option value="C">Option C</option>
            <option value="D">Option D</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" onclick="saveQuestionEdit()">
          Save Changes
        </button>
      </div>
    </div>
  </div>
  </div>

  <!-- Student Details Modal -->
  <div class="modal" id="student-details-modal">
    <div class="modal-content glass-panel" style="max-width: 800px; width: 95%;">
      <div class="modal-header">
        <h3>Student Insight</h3>
        <button class="close-btn" onclick="closeStudentModal()">Ã—</button>
      </div>
      <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
        <div
          style="display: flex; justify-content: space-between; margin-bottom: 20px; background: rgba(0,0,0,0.03); padding: 15px; border-radius: 8px;">
          <div>
            <strong>Score:</strong> <span id="detail-score" style="font-size: 1.2rem;">--</span>
          </div>
          <div>
            <strong>Cheat Status:</strong> <span id="detail-cheated">--</span>
          </div>
        </div>

        <h4>CO Proficiency</h4>
        <div id="detail-co-stats" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
          <!-- CO badges -->
        </div>

        <h4>Question Breakdown</h4>
        <div id="detail-answers-list" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Q&A list -->
        </div>
      </div>
    </div>
  </div>

  <script src="js/config.js?v=3"></script>
  <script src="js/app.js?v=3"></script>
  <script>
    // HTML Hack: Define missing function that app.js calls
    function refreshStepperState() {
      const syllabusText = document.getElementById('syllabus-text');
      const hasContent = syllabusText && syllabusText.value.trim().length > 0;
      if (typeof questions !== 'undefined' && questions.length > 0) {
        updateStepper(3);
      } else if (hasContent) {
        updateStepper(2);
      } else {
        updateStepper(1);
      }
    }

    // HTML Hack: Suppress "Generated X questions successfully" popup
    const originalAlert = window.alert;
    window.alert = function (msg) {
      if (msg && msg.includes('questions successfully')) {
        console.log(msg); // Log to console instead
        return;
      }
      originalAlert(msg);
    };
  </script>
</body>

</html>